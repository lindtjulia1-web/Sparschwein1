<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KGB Piggy Bank Pro Editor</title>
    <style>
        :root { --accent: #f9e076; --bg: #1e1e24; --panel: #2a2a32; --border: #3d3d45; --green: #4caf50; --red: #f44336; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 400px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        h2 { color: var(--accent); font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; margin: 20px 0 10px; border-left: 3px solid var(--accent); padding-left: 10px; }
        
        .card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 12px; border-radius: 15px; margin-bottom: 10px; position: relative; }
        .del-btn { position: absolute; top: 8px; right: 10px; color: var(--red); cursor: pointer; font-size: 10px; font-weight: bold; }
        
        label { display: block; font-size: 10px; color: #aaa; text-transform: uppercase; margin-top: 8px; }
        input, select { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 8px; margin-top: 4px; box-sizing: border-box; outline: none; font-size: 13px; }
        
        .btn { border: none; padding: 14px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-add { background: #444; color: #fff; font-size: 11px; padding: 8px; }
        .btn-main { background: #ffb347; color: #000; } 
        .btn-code { background: #77dd77; color: #000; } 

        .preview { flex: 1; background: #0c0c0e; display: flex; align-items: center; justify-content: center; padding: 40px; }
        #device-wrapper { position: relative; background: #000; border-radius: 30px; }
        iframe { width: 100%; height: 100%; border: none; display: block; border-radius: 30px; }
        
        #code-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
        textarea { width: 80%; height: 50%; background: #111; color: var(--accent); padding: 20px; border: 1px solid var(--accent); border-radius: 20px; font-family: monospace; }
        
        .color-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .neon-toggle { display: flex; align-items: center; gap: 10px; margin-top: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; cursor: pointer; }
        .neon-toggle input { width: auto; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-content">
        <h2>Настройки Экрана</h2>
        <div class="color-grid">
            <div><label>Ширина</label><input type="number" id="width" value="400"></div>
            <div><label>Высота</label><input type="number" id="height" value="600"></div>
        </div>
        <label>Фон (URL)</label>
        <input type="text" id="bg-url" placeholder="URL картинки">

        <h2>Эффекты Виджета</h2>
        <label class="neon-toggle">
            <input type="checkbox" id="neon-enabled" checked>
            <span style="font-size: 11px; font-weight: bold;">ВКЛЮЧИТЬ НЕОН</span>
        </label>
        <label>Цвет Неона</label>
        <input type="color" id="neon-color" value="#f9e076">

        <h2>Уровни сложности</h2>
        <div id="levels-container"></div>
    </div>
    
    <div style="padding: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-main" onclick="updatePreview()">ОБНОВИТЬ ПРЕВЬЮ</button>
        <button class="btn btn-code" onclick="getGeniallyCode()">ПОЛУЧИТЬ КОД</button>
    </div>
</div>

<div class="preview">
    <div id="device-wrapper"><iframe id="ifr"></iframe></div>
</div>

<div id="code-modal">
    <textarea id="result-code" readonly onclick="this.select()"></textarea>
    <button class="btn" onclick="document.getElementById('code-modal').style.display='none'" style="width: 200px; background:#fff; color:#000;">ЗАКРЫТЬ</button>
</div>

<script>
const GITHUB_RAW = "https://raw.githubusercontent.com/lindtjulia1-web/Sparschwein1/main/";

for(let i=1; i<=4; i++) {
    const lvlDiv = document.createElement('div');
    lvlDiv.innerHTML = `<h3>Уровень ${i}</h3><div id="q-container-lvl-${i}"></div><button class="btn btn-add" onclick="addQ(${i})">+ Добавить вопрос</button>`;
    document.getElementById('levels-container').appendChild(lvlDiv);
}

function addQ(lvl, q="", c="", w="") {
    const container = document.getElementById(`q-container-lvl-${lvl}`);
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<span class="del-btn" onclick="this.parentElement.remove()">УДАЛИТЬ</span>
        <label>Вопрос</label><input type="text" class="inp-q" value="${q}">
        <label style="color:var(--green)">Верный</label><input type="text" class="inp-correct" value="${c}">
        <label style="color:var(--red)">Ложные</label><input type="text" class="inp-wrong" value="${w}">`;
    container.appendChild(div);
}

function buildInnerGame() {
    const levels = [];
    for(let i=1; i<=4; i++) {
        const cards = Array.from(document.querySelectorAll(`#q-container-lvl-${i} .card`));
        const questions = cards.map(c => ({
            q: c.querySelector('.inp-q').value,
            a: [c.querySelector('.inp-correct').value, ...c.querySelector('.inp-wrong').value.split(',').map(x => x.trim())]
        })).filter(x => x.q);
        levels.push(questions);
    }

    const cfg = {
        bg: document.getElementById('bg-url').value,
        neon: document.getElementById('neon-color').value,
        neonEnabled: document.getElementById('neon-enabled').checked,
        levels: levels,
        pigs: [GITHUB_RAW+"1.png", GITHUB_RAW+"2.png", GITHUB_RAW+"3.png", GITHUB_RAW+"4.png", GITHUB_RAW+"5.png", GITHUB_RAW+"6.png"],
        coin: GITHUB_RAW+"7.png"
    };

    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <style>
        body { 
            margin:0; height:100vh; overflow:hidden; font-family: sans-serif; background:#000; color:#fff; display:flex; flex-direction:column; 
            border-radius:30px; position: relative; box-sizing: border-box;
            border: ${cfg.neonEnabled ? '6px solid '+cfg.neon : 'none'};
            animation: ${cfg.neonEnabled ? 'neon-pulse 3s infinite linear' : 'none'};
        }
        @keyframes neon-pulse {
            0%, 100% { box-shadow: inset 0 0 15px ${cfg.neon}, 0 0 15px ${cfg.neon}; }
            50% { box-shadow: inset 0 0 30px ${cfg.neon}, 0 0 40px ${cfg.neon}; }
        }
        @keyframes gold-sparkle {
            0%, 100% { filter: drop-shadow(0 0 5px gold) brightness(1); }
            50% { filter: drop-shadow(0 0 20px #f9e076) brightness(1.3); }
        }
        .bg { position:fixed; inset:0; background:url(${cfg.bg}) center/cover; opacity:0.5; z-index:-1; }
        #game { height:100%; display:flex; flex-direction:column; padding:10vmin; box-sizing:border-box; }
        .score-box { font-size:10vmin; color:#f9e076; text-align:center; text-shadow: 0 0 15px gold; z-index:10; }
        #pile-box { flex:1; position:relative; display:flex; justify-content:center; align-items:center; }
        .pig { width:70vmin; z-index:5; animation: gold-sparkle 3s infinite; }
        .coin-element { position:absolute; width:7vmin; height:7vmin; background:url(${cfg.coin}) center/cover; animation: gold-sparkle 2s infinite alternate; }
        .falling-coin { position:absolute; top:-10vh; width:8vmin; height:8vmin; background:url(${cfg.coin}) center/cover; z-index:10; filter: drop-shadow(0 0 10px gold); }
        .btn-grid { display:grid; gap:2vmin; width:100%; margin-top:2vmin; }
        button { 
            border:none; background:#f9e076; color:#000; padding:3vmin; border-radius:15px; 
            font-weight:bold; cursor:pointer; animation: gold-sparkle 4s infinite; 
        }
        #firework-canvas { position:absolute; inset:0; pointer-events:none; z-index:20; display:none; }
        @keyframes fallIn { 0% { top:-10vh; } 100% { top: 50%; opacity: 0; } }
    </style></head><body>
        <canvas id="firework-canvas"></canvas>
        <div class="bg"></div>
        <div id="game">
            <div class="score-box" id="total-score">0</div>
            <div id="pile-box"><img id="pig-img" src="${cfg.pigs[0]}" class="pig"><div id="pile" style="position:absolute; inset:0;"></div></div>
            <div id="q-label" style="text-align:center; font-size:5vmin; margin-top:2vmin;"></div>
            <div id="btn-area" class="btn-grid"></div>
        </div>
    <script>
        const cfg = ${JSON.stringify(cfg)};
        let score = 0, currentLvl = 0, currentQ = 0;

        // Звуковой движок (синтезированный, чтобы не зависеть от внешних файлов)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function playCoin() { playSound(900 + Math.random()*200, 'sine', 0.2); }
        function playWin() { playSound(500, 'square', 0.1); setTimeout(()=>playSound(800, 'square', 0.3), 100); }
        function playFail() { playSound(150, 'sawtooth', 0.4); }

        function startGame() { showQuestion(); }
        function showQuestion() {
            const data = cfg.levels[currentLvl][currentQ];
            document.getElementById('q-label').innerText = data.q;
            const area = document.getElementById('btn-area'); area.innerHTML = '';
            data.a.forEach((txt, i) => {
                const b = document.createElement('button'); b.innerText = txt;
                b.onclick = () => {
                    if(i === 0) { 
                        score += 50; playWin(); spawnCoins(5); 
                        if(currentLvl < 5) document.getElementById('pig-img').src = cfg.pigs[currentLvl+1];
                    } else { 
                        score = Math.max(0, score - 20); playFail(); 
                    }
                    document.getElementById('total-score').innerText = score;
                    currentQ++; 
                    if(currentQ >= cfg.levels[currentLvl].length) { currentLvl++; currentQ=0; }
                    if(currentLvl >= cfg.levels.length) finishGame(); else setTimeout(showQuestion, 1000);
                }; area.appendChild(b);
            });
        }

        function spawnCoins(num) {
            for(let i=0; i<num; i++) {
                setTimeout(() => {
                    const c = document.createElement('div'); c.className = 'falling-coin';
                    c.style.left = (40 + Math.random()*20) + '%';
                    c.style.animation = 'fallIn 1s forwards';
                    document.body.appendChild(c);
                    playCoin();
                    setTimeout(() => { c.remove(); addToPile(); }, 900);
                }, i * 100);
            }
        }

        function addToPile() {
            const p = document.getElementById('pile'); const c = document.createElement('div');
            c.className = 'coin-element'; c.style.left = (20+Math.random()*60)+'%'; c.style.top = (30+Math.random()*40)+'%';
            p.appendChild(c);
        }

        function finishGame() {
            document.getElementById('q-label').innerText = 'ЗОЛОТО ВАШЕ!';
            document.getElementById('btn-area').innerHTML = '';
            startFireworks();
        }

        function startFireworks() {
            const canvas = document.getElementById('firework-canvas');
            canvas.style.display = 'block';
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const ctx = canvas.getContext('2d');
            let particles = [];
            function create() {
                for(let i=0; i<5; i++) particles.push({
                    x: canvas.width/2, y: canvas.height/2,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 100, color: 'gold'
                });
            }
            function loop() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                create();
                particles.forEach((p,i) => {
                    p.x += p.vx; p.y += p.vy; p.life--;
                    ctx.fillStyle = p.color; ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                    if(p.life <= 0) particles.splice(i,1);
                });
                requestAnimationFrame(loop);
            }
            loop();
        }
        startGame();
    <\/script></body></html>`;
}

function updatePreview() {
    const w = document.getElementById('width').value;
    const h = document.getElementById('height').value;
    const wrapper = document.getElementById('device-wrapper');
    wrapper.style.width = w + 'px'; wrapper.style.height = h + 'px';
    document.getElementById('ifr').srcdoc = buildInnerGame();
}

function getGeniallyCode() {
    const html = buildInnerGame().replace(/"/g, '&quot;');
    const code = `<iframe width="${document.getElementById('width').value}" height="${document.getElementById('height').value}" srcdoc="${html}" frameborder="0" scrolling="no" style="border-radius:30px;"></iframe>`;
    document.getElementById('result-code').value = code;
    document.getElementById('code-modal').style.display = 'flex';
}

window.onload = () => { addQ(1, "Где золото?", "В копилке", "В море"); updatePreview(); }
</script>
</body>
</html>
